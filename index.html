<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#000000" />
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <title>TI-89 Calculator</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease-out;
        }

        .loading-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .calculator-icon {
            width: 80px;
            height: 80px;
            background-image: url('./icons/icon-192.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 20px;
        }

        .loading-text {
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .simulator-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .error-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            margin-bottom: 16px;
            color: #ff4444;
        }

        .error-message {
            font-size: 16px;
            margin-bottom: 24px;
            color: #ccc;
            line-height: 1.4;
        }

        .retry-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .retry-button:hover {
            background: #005999;
        }

        /* iOS Debug Panel Styles */
        .debug-panel {
            position: fixed;
            bottom: -200px;
            left: 10px;
            right: 10px;
            height: 180px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 12px;
            z-index: 10002;
            transition: bottom 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .debug-panel.show {
            bottom: env(safe-area-inset-bottom, 10px);
        }

        .debug-panel h4 {
            margin: 0 0 10px 0;
            color: #4CAF50;
            font-size: 14px;
        }

        .debug-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        .debug-button:active {
            background: #1976D2;
        }

        .debug-info {
            font-size: 10px;
            color: #ccc;
            margin-top: 8px;
            max-height: 60px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <noscript>This app requires JavaScript to run the TI-89 calculator.</noscript>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="calculator-icon"></div>
        <div class="loading-text">Loading TI-89 Calculator...</div>
        <div class="spinner"></div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Connection Error</div>
        <div class="error-message">
            Unable to load the calculator. Please check your internet connection and try again.
        </div>
        <button class="retry-button" onclick="retryLoad()">Retry</button>
    </div>

    <!-- Calculator Iframe -->
    <iframe
        id="calculatorFrame"
        class="simulator-frame"
        src="about:blank"
        allowfullscreen>
    </iframe>

    <!-- iOS Debug Panel (Hidden by default) -->
    <div id="debugPanel" class="debug-panel">
        <h4>TI-89 State Management Debug</h4>
        <div>
            <button class="debug-button" onclick="debugSave()">üíæ Save Now</button>
            <button class="debug-button" onclick="debugRestore()">‚Ü©Ô∏è Restore</button>
            <button class="debug-button" onclick="debugClear()">üóëÔ∏è Clear</button>
            <button class="debug-button" onclick="debugInfo()">üìä Info</button>
            <button class="debug-button" onclick="hideDebugPanel()">‚ùå Hide</button>
        </div>
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <!-- State Management Scripts -->
    <script src="./js/storage-fallback.js"></script>
    <script src="./js/state-manager.js"></script>
    <script src="./js/ios-state-manager.js"></script>

    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(console.error);
        }

        let loadTimeout;
        let retryCount = 0;
        const maxRetries = 3;
        let stateManager = null;

        function loadCalculator() {
            const iframe = document.getElementById('calculatorFrame');
            const loadingScreen = document.getElementById('loadingScreen');
            const errorScreen = document.getElementById('errorScreen');

            // Reset displays
            loadingScreen.classList.remove('hide');
            errorScreen.style.display = 'none';

            // Set a timeout for loading
            loadTimeout = setTimeout(() => {
                showError();
            }, 15000); // 15 second timeout

            // Load the calculator
            iframe.src = 'https://ti89-simulator.com/';

            iframe.onload = function() {
                clearTimeout(loadTimeout);
                loadingScreen.classList.add('hide');

                // Initialize state management
                initializeStateManagement(iframe);

                // Add some delay for smoother transition
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            };

            iframe.onerror = function() {
                clearTimeout(loadTimeout);
                showError();
            };
        }

        function showError() {
            const loadingScreen = document.getElementById('loadingScreen');
            const errorScreen = document.getElementById('errorScreen');

            loadingScreen.classList.add('hide');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                errorScreen.style.display = 'flex';
            }, 300);
        }

        function retryLoad() {
            if (retryCount < maxRetries) {
                retryCount++;
                loadCalculator();
            } else {
                // Max retries reached, show persistent error
                const errorMessage = document.querySelector('.error-message');
                errorMessage.innerHTML = 'Maximum retry attempts reached. The calculator service may be temporarily unavailable.';
                document.querySelector('.retry-button').style.display = 'none';
            }
        }

        // Handle PWA install prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Handle app visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && window.navigator.onLine) {
                // App became visible and online, refresh if there was an error
                const errorScreen = document.getElementById('errorScreen');
                if (errorScreen.style.display === 'flex' || errorScreen.style.display === '') {
                    retryCount = 0; // Reset retry count
                    loadCalculator();
                }
            }
        });

        // Handle online/offline events
        window.addEventListener('online', () => {
            const errorScreen = document.getElementById('errorScreen');
            if (errorScreen.style.display === 'flex') {
                retryCount = 0;
                loadCalculator();
            }
        });

        window.addEventListener('offline', () => {
            showError();
            const errorMessage = document.querySelector('.error-message');
            errorMessage.innerHTML = 'You appear to be offline. The calculator requires an internet connection to function.';
        });

        // Prevent zoom on double-tap for better app feel
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        /**
         * Detect if running on iOS
         */
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        /**
         * Detect if running as standalone PWA
         */
        function isStandalonePWA() {
            return window.navigator.standalone === true ||
                   window.matchMedia('(display-mode: standalone)').matches;
        }

        /**
         * Initialize state management for the calculator
         */
        async function initializeStateManagement(iframe) {
            try {
                console.log('Platform detection:', {
                    isIOS: isIOS(),
                    isStandalone: isStandalonePWA(),
                    userAgent: navigator.userAgent
                });

                // Create appropriate state manager based on platform
                if (!stateManager) {
                    if (isIOS()) {
                        console.log('Initializing iOS-specific state manager');
                        stateManager = new iOSStateManager();

                        // Set up iOS-specific lifecycle handlers
                        stateManager.setupiOSLifecycleHandlers();

                        // Set iframe and try to restore immediately
                        stateManager.setIframe(iframe);

                        // Try to restore state after a short delay
                        setTimeout(() => {
                            stateManager.restoreState();
                        }, 2000);

                        // Start iOS auto-save (more frequent)
                        setTimeout(() => {
                            stateManager.startAutoSave(10000); // Every 10 seconds on iOS
                        }, 3000);

                    } else {
                        console.log('Initializing standard state manager');
                        stateManager = new TI89StateManager();

                        // Set the iframe reference
                        stateManager.setIframe(iframe);

                        // Wait a moment for iframe to fully load
                        setTimeout(async () => {
                            try {
                                // Try to inject the bridge script into the iframe
                                await injectBridgeScript(iframe);

                                // Load any saved state
                                const savedState = await stateManager.loadState();
                                if (savedState) {
                                    console.log('Found saved calculator state, attempting to restore...');
                                    // Wait a bit more for the calculator to initialize
                                    setTimeout(() => {
                                        stateManager.sendStateToCalculator(savedState);
                                    }, 3000);
                                }

                                // Start auto-save after initialization
                                setTimeout(() => {
                                    stateManager.startAutoSave(30000); // Save every 30 seconds
                                }, 5000);

                            } catch (error) {
                                console.log('Could not inject bridge script (likely due to CORS), using fallback method');
                                // Start periodic state requests as fallback
                                startFallbackStateCapture();
                            }
                        }, 2000);
                    }
                }

            } catch (error) {
                console.error('Failed to initialize state management:', error);
            }
        }

        /**
         * Try to inject the bridge script into the iframe
         */
        async function injectBridgeScript(iframe) {
            return new Promise((resolve, reject) => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    // Load the bridge script
                    fetch('./js/calculator-bridge.js')
                        .then(response => response.text())
                        .then(scriptContent => {
                            const script = iframeDoc.createElement('script');
                            script.textContent = scriptContent;
                            iframeDoc.head.appendChild(script);
                            console.log('Bridge script injected successfully');
                            resolve();
                        })
                        .catch(reject);

                } catch (error) {
                    reject(error);
                }
            });
        }

        /**
         * Fallback state capture method when direct injection fails
         */
        function startFallbackStateCapture() {
            console.log('Starting fallback state capture method');

            // Use postMessage to try to communicate with the iframe
            setInterval(() => {
                if (stateManager && stateManager.iframe) {
                    stateManager.requestStateFromCalculator();
                }
            }, 30000); // Try every 30 seconds
        }

        /**
         * Handle app lifecycle events for state persistence
         */
        function setupAppLifecycleHandlers() {
            // Save state when app is about to be hidden
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && stateManager) {
                    stateManager.requestStateFromCalculator();
                }
            });

            // Save state before page unload
            window.addEventListener('beforeunload', () => {
                if (stateManager) {
                    stateManager.requestStateFromCalculator();
                }
            });

            // Handle page hide (mobile Safari)
            window.addEventListener('pagehide', () => {
                if (stateManager) {
                    stateManager.requestStateFromCalculator();
                }
            });
        }

        /**
         * Add manual controls for state management (for debugging)
         */
        function addStateManagementControls() {
            // Add keyboard shortcuts for development/debugging
            document.addEventListener('keydown', (event) => {
                if (event.ctrlKey || event.metaKey) {
                    switch (event.key.toLowerCase()) {
                        case 's':
                            // Ctrl/Cmd + S: Manual save
                            event.preventDefault();
                            if (stateManager) {
                                stateManager.requestStateFromCalculator();
                                console.log('Manual state save requested');
                            }
                            break;
                        case 'r':
                            // Ctrl/Cmd + R: Manual restore
                            if (event.shiftKey) {
                                event.preventDefault();
                                if (stateManager) {
                                    stateManager.loadState().then(state => {
                                        if (state) {
                                            stateManager.sendStateToCalculator(state);
                                            console.log('Manual state restore requested');
                                        }
                                    });
                                }
                            }
                            break;
                        case 'd':
                            // Ctrl/Cmd + D: Delete saved state
                            if (event.shiftKey) {
                                event.preventDefault();
                                if (stateManager && confirm('Delete all saved calculator state?')) {
                                    stateManager.clearState();
                                    console.log('Saved state cleared');
                                }
                            }
                            break;
                    }
                }
            });
        }

        // iOS Debug Functions
        function debugSave() {
            if (stateManager) {
                if (stateManager.forceSave) {
                    const result = stateManager.forceSave();
                    updateDebugInfo(JSON.stringify(result, null, 2));
                } else {
                    stateManager.requestStateFromCalculator();
                    updateDebugInfo('Save requested (standard mode)');
                }
            } else {
                updateDebugInfo('No state manager available');
            }
        }

        function debugRestore() {
            if (stateManager) {
                if (stateManager.forceRestore) {
                    const result = stateManager.forceRestore();
                    updateDebugInfo(`Restore result: ${result}`);
                } else {
                    stateManager.loadState().then(state => {
                        if (state) {
                            stateManager.sendStateToCalculator(state);
                            updateDebugInfo('Restore requested (standard mode)');
                        } else {
                            updateDebugInfo('No saved state found');
                        }
                    });
                }
            } else {
                updateDebugInfo('No state manager available');
            }
        }

        function debugClear() {
            if (stateManager && confirm('Clear all saved state?')) {
                stateManager.clearState();
                updateDebugInfo('State cleared');
            }
        }

        function debugInfo() {
            if (stateManager) {
                if (stateManager.getDiagnostics) {
                    const diagnostics = stateManager.getDiagnostics();
                    updateDebugInfo(JSON.stringify(diagnostics, null, 1));
                } else {
                    updateDebugInfo('Standard state manager active');
                }
            } else {
                updateDebugInfo('No state manager available');
            }
        }

        function updateDebugInfo(text) {
            const debugInfoElement = document.getElementById('debugInfo');
            debugInfoElement.textContent = text;
        }

        function showDebugPanel() {
            document.getElementById('debugPanel').classList.add('show');
        }

        function hideDebugPanel() {
            document.getElementById('debugPanel').classList.remove('show');
        }

        // Touch gesture to show debug panel (triple tap in bottom corner)
        let tapCount = 0;
        let tapTimer = null;
        document.addEventListener('touchstart', (event) => {
            if (event.touches.length === 1) {
                const touch = event.touches[0];
                const windowHeight = window.innerHeight;
                const windowWidth = window.innerWidth;

                // Check if touch is in bottom-right corner (100px square)
                if (touch.clientX > windowWidth - 100 &&
                    touch.clientY > windowHeight - 100) {

                    tapCount++;

                    if (tapTimer) {
                        clearTimeout(tapTimer);
                    }

                    tapTimer = setTimeout(() => {
                        if (tapCount >= 3) {
                            showDebugPanel();
                        }
                        tapCount = 0;
                    }, 500);
                }
            }
        });

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadCalculator();
            setupAppLifecycleHandlers();
            addStateManagementControls();

            // Show debug panel automatically on iOS for testing
            if (isIOS()) {
                setTimeout(() => {
                    showDebugPanel();
                    updateDebugInfo('iOS detected. Debug panel active.\nTriple-tap bottom-right corner to show again.');
                }, 5000);
            }
        });
    </script>
</body>
</html>
